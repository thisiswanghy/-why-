这是 why 技术的第 34 篇原创文章

![](https://user-gold-cdn.xitu.io/2020/2/16/1704d1520a72ff74?w=1280&h=586&f=jpeg&s=41032)

本周还是在家办公的一周，上面的图就是我在家的工位，和上周《Dubbo Cluster 集群那点你不知道的事》这篇文章里面的第一张图片比起来，升级了显示器支撑臂，如果短还可以加长；用上了机械键盘，让指尖享受那一点点来自红轴的美妙反馈......

还是那句话：工欲善其事，必先利其器。在家办公，我是认真的。

图中显示器下面的两本书分别是《深入理解 Java 虚拟机》的第 2 版和第 3 版。也就是本文的主角。

你的手边有第 2 版吗？

来，翻到第 57 页。这里面有个“坑”，看看你当时发现了没，有没有在这页做笔记呢？

![](https://user-gold-cdn.xitu.io/2020/2/16/1704d15778fca51b?w=300&h=396&f=jpeg&s=23108)

没有也没关系，我带你先回顾一下这一页的内容，再让你看看我三年前第一次看这书的时候做的笔记。

# 第 2 版 57 页讲了啥？

也许你根本就没看过《深入理解 Java 虚拟机(第 2 版)》这本书。但是你一定见过位于本书第 57 页的示例代码：

![](https://user-gold-cdn.xitu.io/2020/2/16/1704d15bd87069e6?w=890&h=236&f=png&s=52836)

**由于 JDK 6 常量池位于方法区，JDK 7 以后常量池位于堆中，所以用两个版本的 jdk 跑上面的代码就会出现神奇的事情。甚至用 JDK 8 来跑，也会出现你想不到的结果。且听我慢慢道来。**

先说一下 intern 是干啥的。

**该方法的作用是把首次遇到的字符串加载到常量池中**。

再看一下 intern 的注释：

![](https://user-gold-cdn.xitu.io/2020/2/16/1704d16640a81cc2?w=690&h=586&f=png&s=68069)

其中标记了 ☆ 的红框翻译过来就是：**对于任意两个字符串 s 和 t，当且仅当 s.equals(t) 为 true 时，s.intern() == t.intern() 才为 true。**

回到最开始的代码中。引用第三版的描述如下：

**这段代码在 JDK 6 中运行，会得到两个 false，而在 JDK 7 中运行，会得到一个 true 和一个 false。**

产生差异的原因是：在 JDK 6 中，intern()方法会把首次遇到的字符串实例复制到永久代的字符串常量池中存储，**返回的也是永久代里面这个字符串实例的引用**，而由 StringBuilder 创建的字符串实例**在 Java 堆上**，所以必然不是同一个引用，将返回 false。

而 JDK 1.7（以及部分其他虚拟机，例如 JRocki）的 intern()实现就不需要再拷贝字符串的实例到永久代了，**既然字符串常量池已经移到了 Java 堆中**，那只需要在常量池里记录一下首次出现的实例引用即可，**因此 intern()返回的引用和由 StringBuilder 创建的那个字符串实例就是同一个。**

对 str2 比较返回 false 是**因为“java”这个字符串在执行 StringBuilder.toString()之前已经出现过，**字符串常量池中已经有它的引用了，不符合 intern()方法要求“首次出现”的原则，而“计算机软件”这个字符串则是首次出现的，因此返回 true。

![](https://user-gold-cdn.xitu.io/2020/2/16/1704d17d0e2cece0?w=300&h=264&f=jpeg&s=10611)

# 挖坑不填，坑哭读者

读到这里你有没有一些不惑呢？有没有感觉到一丝丝不对呢？

我们再看看原文：

![](https://user-gold-cdn.xitu.io/2020/2/16/1704d180df5c49c8?w=640&h=851&f=jpeg&s=169691)

为什么在 JDK 7 里面会返回 fasle，上面红框框起来的部分是关键答案：

**因为“java”这个字符串在执行 StringBuilder.toString()之前已经出现过。**

这句话就是“坑”，已经出现过？在哪出现的，你倒是告诉我啊！我当时的内心想法和下面的老大哥是一样一样的：

![](https://user-gold-cdn.xitu.io/2020/2/16/1704d185eaaa3eb8?w=240&h=135&f=gif&s=859045)

我第一次看这本书是在 2016 年，看这个地方的时候，我就百思不得其解，在哪就出现过了呀？

当时也不知道是在哪个写的似是而非的博客里面找到“java 是关键字，已存在常量池中”这句“骚话”。还正正经经的抄了上去，虽然是错误的描述，虽然字是丑了点......

![](https://user-gold-cdn.xitu.io/2020/2/16/1704d18a1226fc5e?w=300&h=244&f=jpeg&s=13811)

你当年或者现在看的时候有这个疑惑吗？

之后我又完整的看过几次这本书，我清楚的记得，我再一次看到这里的时候我就觉得**“java 是关键字，已存在常量池中”这个描述是不对的**，所以我在后面打了一把叉，再次去找了相关资料，找到了 sun.misc.version，终于解决了“在哪出现的”这个问题。

# 第 3 版注脚填坑

这个 2013 年（第二版出版那年）挖下的坑，在 2016 年 10 月 1 日，就被 R 大在知乎上给填上了。R 大的这个回答也被作者周志明写在了 2019 年底出版的《深入理解 Java 虚拟机（第三版）》的注脚里面：

![](https://user-gold-cdn.xitu.io/2020/2/16/1704d197314bc68e?w=925&h=107&f=jpeg&s=38165)

里面的 RednaxelaFX 就是 R 大，一个把虚拟机玩到极致，凭一己之力撑起了知乎 java 半边天的男人，后面我会详细介绍一下的。

你只要了解到一点就行：他的回答，就是权威。

![](https://user-gold-cdn.xitu.io/2020/2/16/1704d19aeeb32140?w=300&h=264&f=gif&s=38724)

在 R 大的这个知乎回答中，帮周志明大大填了这个坑，**我强烈建议你一定要去看看，链接如下**：

`https://www.zhihu.com/question/51102308/answer/124441115`

# R 大帮忙填坑

我这里只是结合 R 大的回答和个人的一点点经验，谈谈自己的认知。

在 2016 年我读这本书的时候，我才刚刚大学毕业，刚从新手村出来。当时的我对于这个问题是绝对没有任何思路的，必须直接在网上查询答案。

现在的我，略有一点经验，再次遇到这个问题，就算没看书中的描述、R 大的回答，我肯定也会想到：在书中的示例里面，第二个输出 false，**说明调用 main 方法之前，肯定在字符串常量池里面已经有了这个“java”字符串了。**

怎么验证一下呢？

我们在 main 方法的第一行打上一个断点，debug 运行程序后，可以看到 Memory，然后过滤出 String，如下：

![](https://user-gold-cdn.xitu.io/2020/2/16/1704d1ae24e8eb38?w=784&h=567&f=png&s=57094)

然后双击过滤出来的 java.lang.String，可以看到下图：

![](https://user-gold-cdn.xitu.io/2020/2/16/1704d1afa0d5f29b?w=910&h=492&f=png&s=82393)

在这个页面我们可以继续过滤：

![](https://user-gold-cdn.xitu.io/2020/2/16/1704d1b12acf5bd0?w=910&h=492&f=png&s=55541)

果然，在程序还没执行第 14 行之前，“java”已经出现了。

从这个结果我们可以推断出：**Java 标准库在 JVM 启动过程中加载的部分，可能里面就有类里有引用“java”字符串字面量，这个字面量被初次引用的时候就会被 intern，加入到字符串常量池中去。**

**而到底是哪个类导致了这个“java”字符串被 intern 的呢？**R 大主要就是回答了这个问题。

我截取一下 R 大最终的答案，具体探索的过程去看他的回答吧，很强很硬核：

![](https://user-gold-cdn.xitu.io/2020/2/16/1704d1b7463aa4b8?w=675&h=359&f=png&s=47116)

**我们可以看到 sum.misc.Version 里面的 launcher_name 字段的值就是“java”:**

![](https://user-gold-cdn.xitu.io/2020/2/16/1704d1bbdadc69c5?w=853&h=312&f=png&s=31381)

而根据 R 大的回答，我们可以找到 java.lang.System 类：

![](https://user-gold-cdn.xitu.io/2020/2/16/1704d1bd77ab7c8e?w=806&h=978&f=jpeg&s=223057)

根据 System 类的注释我们可以知道，它是由虚拟机自动调用的。而其 initializeSystemClass 方法会调用 sun.misc.Version.init()方法。

到此就真相大白了。

**Java 标准库在 JVM 启动过程中会调用 sun.misc.Version 的 init()方法。所以 sun.misc.Version 会进行初始化的操作，而初始化时，会对静态常量字段进行真正的赋值操作，此时，sun.misc.Version 的 launcher_name 字段所引用的字符串“java”就被 intern 到了字符串常量池里面了。**

`可以在心里在默默的复习一下类加载的过程：加载、验证、准备、解析和初始化这五个阶段哦。`

另外书中给出的示例代码也有一定的局限性，R 大是这样说的：

`其实这事情很简单：首先，这个行为必然是要针对某个具体的JDK/JRE实现来讨论的，因为Java语言规范/JVM规范/Java SE标准库的JavaDoc(也是Java SE平台规范的一部分)都没有、也不会强制指定哪个类里一定要引用“java”这个字符串常量，而且它必须是第一个使得“java”被intern的类 --- 规定这个也太无聊了。`

比如这个示例我在 JDK8u212-b03 上跑出来，就是两个 true：

![](https://user-gold-cdn.xitu.io/2020/2/16/1704d1c9a54d64e1?w=775&h=362&f=png&s=35737)

在这个版本里面，sun.misc.Version 的 launcher_name 变成了“openjdk”：

![](https://user-gold-cdn.xitu.io/2020/2/16/1704d1cb6fcddcf5?w=532&h=265&f=png&s=16619)

那么根据我们之前的猜测，把程序成下面这样的，效果就是一样的了：

![](https://user-gold-cdn.xitu.io/2020/2/16/1704d1cca60a7fa7?w=772&h=356&f=png&s=36637)

万变不离其宗，现在你知道为什么这里用 openjdk 返回也是 false 了吧。

知其然，还要知其所以然。

![](https://user-gold-cdn.xitu.io/2020/2/16/1704d1ce0c4951f7?w=274&h=239&f=gif&s=16550)

# R 大与周志明之间的“爱恨情仇”

R 大是谁？

![](https://user-gold-cdn.xitu.io/2020/2/16/1704d1d1abf06367?w=150&h=145&f=gif&s=80397)

我先上一张《深入理解 java 虚拟机(第二版)》背面的一张图吧，R 大给这本书写过推荐语：

![](https://user-gold-cdn.xitu.io/2020/2/16/1704d1d312c73977?w=967&h=326&f=jpeg&s=100673)

**莫枢（RednaxelaFx）Oracle HotSpot VM 编译器团队工程师。**(现在他已经不在 Oracle 了。据网上公开资料，R 大是前阿里巴巴技术专家，前 Oracle JVM 核心开发，前 Azul 核心开发，现就职于 Databricks)

再看一下他的知乎主页：`https://www.zhihu.com/people/rednaxelafx/answers`

![](https://user-gold-cdn.xitu.io/2020/2/16/1704d1dbdda6b00d?w=1006&h=863&f=jpeg&s=205512)

你去知乎上只搜 RednaxelaFX（甚至直接用搜索引擎搜索），就能搜到很多结果，我随便截取一个片段。

在【有哪些顶级水平的中国程序员？】这个话题下，有一个回答只是@一下 R 大的 ID，没有多说一个字，就获得了 258 个赞，评论中也满是赞美的语言，干货多，就是他的特点：

![](https://user-gold-cdn.xitu.io/2020/2/16/1704d1dd49fd85af?w=671&h=1528&f=jpeg&s=198209)

他与《深入理解 Java 虚拟机》的作者周志明大大，在 2010 年到 2011 年间，在 iteye 上已经有过多次深度交流，比如下面的吐槽：

![](https://user-gold-cdn.xitu.io/2020/2/16/1704d1e42ce908a1?w=673&h=500&f=png&s=64913)

比如下面的调侃：

![](https://user-gold-cdn.xitu.io/2020/2/16/1704d1e5f65fb34e?w=632&h=221&f=png&s=17497)

玩归玩，闹归闹，周志明也直言阅读了 R 大的很多文章，受益良多：

![](https://user-gold-cdn.xitu.io/2020/2/16/1704d1e7b3005cb5?w=668&h=877&f=jpeg&s=248526)

并且在书里的致谢章节专门谢谢了 R 大：

![](https://user-gold-cdn.xitu.io/2020/2/16/1704d1e8ec89d87f?w=863&h=472&f=jpeg&s=143892)

说这么多，我想要表达的观点其实就是一个：

R 大是一个宝藏啊，他乐于分享和交流，凭借一己之力推动了国内 jvm 的学习和研究，如果你想要了解虚拟机、编译原理和编程语言方面的相关知识，他是一个你绕不过的人。他值得被更多的程序员知道。

如果你之前不知道，但看了我这篇文章后知道了他，我的目的就达到了。

他在知乎上认认真真码字，用心的对待每一个回答，他是一个"码"宗强者，恐怖如斯，但是从他的各种回答、博客文章中，你可以感觉到谦逊、细致、系统、耐心、专业、严谨.....就像一个评论说的：

在技术圈日益浮躁的今天，感觉他就是主席所说的那种：**一个纯粹的人，一个有道德的人，一个脱离了低级趣味的人，一个有益于人民的人。**

我们做程序的，要向他学习，向他致敬。

![](https://user-gold-cdn.xitu.io/2020/2/16/1704d1f00098e21d?w=280&h=180&f=gif&s=1012996)

最后再附上一个 R 大的资料合集链接吧，全是宝藏，待你去发掘：`https://zhuanlan.zhihu.com/p/25042028`

# 最后说一句

才疏学浅，难免会有纰漏，如果你发现了错误的地方，还请你留言给我指出来，我对其加以修改。

如果你觉得文章还不错，你的转发、分享、点赞、留言就是对我最大的鼓励。

感谢您的阅读，我坚持原创，十分欢迎并感谢您的关注。

以上。

欢迎关注公众号【why 技术】,坚持输出原创。分享技术、品味生活，愿你我共同进步。

![](https://user-gold-cdn.xitu.io/2020/2/16/1704d20cd06a0229?w=430&h=430&f=jpeg&s=25735)
